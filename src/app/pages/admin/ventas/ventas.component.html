<div class="container">
    <app-header></app-header>

    <div class="card">
        <div class="info-compras-linea">
            <h5>Ventas registrados</h5>
            <!-- Buscador personalizado sin Angular Material -->
            <div class="mover">
                <div class="buscador">
                    <div class="input-wrapper">
                        <input type="text" id="searchInput" placeholder="Buscador venta" [(ngModel)]="filtroBusqueda"
                            (ngModelChange)="buscarVentas()" />
                        <button type="button" class="btn-icono">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <section class="ventas-buttons">
                    <button (click)="abrirVentaHospedaje()" class="btn-agregar">
                        üè® + Venta Hospedaje
                    </button>
                    <button (click)="abrirVentaProductos()" class="btn-agregar">
                        üõçÔ∏è + Venta Productos
                    </button>
                </section>
            </div>
        </div>
        <div class="filtros-section mb-3">
            <!-- Header -->
            <div class="filtros-header">
                <mat-icon>filter_list</mat-icon>
                <h6>Filtros de B√∫squeda</h6>
            </div>

            <!-- Filtros principales -->
            <div class="row">
                <!-- Tipo de Venta -->
                <div class="col-lg-3 col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Tipo de Venta</mat-label>
                        <mat-select [(value)]="tipoVentaSeleccionado" (selectionChange)="onTipoVentaChange()">
                            <mat-option value="hospedaje">üè® Hospedaje</mat-option>
                            <mat-option value="productos">üõçÔ∏è Productos</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Estado -->
                <div class="col-lg-3 col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Estado</mat-label>
                        <mat-select [(value)]="estadoSeleccionado" (selectionChange)="aplicarFiltros()">
                            <!-- Estados para Productos -->
                            <ng-container *ngIf="tipoVentaSeleccionado === 'productos'">
                                <mat-option value="todos">Todos los estados</mat-option>
                                <mat-option value="Pendiente">‚è≥ Pendiente</mat-option>
                                <mat-option value="Completado">‚úÖ Completado</mat-option>
                            </ng-container>

                            <!-- Estados para Hospedaje -->
                            <ng-container *ngIf="tipoVentaSeleccionado === 'hospedaje'">
                                <mat-option value="todos">Todos los estados</mat-option>
                                <mat-option value="Completado">‚úÖ Completado</mat-option>
                                <mat-option value="Cancelado">‚ùå Cancelado</mat-option>
                            </ng-container>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Fecha Desde -->
                <div class="col-lg-3 col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Fecha Desde</mat-label>
                        <input matInput [matDatepicker]="pickerDesde" [(ngModel)]="fechaDesde"
                            (dateChange)="aplicarFiltros(); validarRangoFechas()" placeholder="dd/mm/aaaa">
                        <mat-datepicker-toggle matIconSuffix [for]="pickerDesde"></mat-datepicker-toggle>
                        <mat-datepicker #pickerDesde></mat-datepicker>
                    </mat-form-field>
                </div>

                <!-- Fecha Hasta -->
                <div class="col-lg-3 col-md-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Fecha Hasta</mat-label>
                        <input matInput [matDatepicker]="pickerHasta" [(ngModel)]="fechaHasta"
                            (dateChange)="aplicarFiltros(); validarRangoFechas()" placeholder="dd/mm/aaaa">
                        <mat-datepicker-toggle matIconSuffix [for]="pickerHasta"></mat-datepicker-toggle>
                        <mat-datepicker #pickerHasta></mat-datepicker>
                    </mat-form-field>
                </div>
            </div>

            <!-- Acciones y resumen -->
            <div class="filtros-acciones">
                <div class="filtros-info" *ngIf="infoResultados">
                    <mat-icon>info</mat-icon>
                    <span>{{ infoResultados }}</span>
                </div>

                <div class="acciones-buttons">
                    <button type="button" mat-stroked-button class="btn-filtro btn-limpiar" (click)="limpiarFiltros()">
                        <mat-icon>clear</mat-icon>
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>


        <table class="tabla-compras mb-5 mt-3">
            <thead>
                <tr>
                    <th>N¬∞ Comprobante</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let venta of ventasPaginados">
                    <td>
                        <span *ngIf="venta.comprobantePago?.numComprobante; else pendiente">
                            {{ venta.comprobantePago.numComprobante }} -
                            {{venta.comprobantePago.numComprobante == 'B001' ?
                            venta.comprobantePago.numSerieBoleta :
                            venta.comprobantePago.numSerieFactura}}
                        </span>
                        <ng-template #pendiente>
                            <span class="text-muted">Sin comprobante</span>
                        </ng-template>
                    </td>
                    <td>{{ venta.fecha | date: 'dd/MM/yyyy'}}</td>
                    <td>{{ venta.cliente.nombre }}</td>
                    <td>S/. {{ venta.total }}</td>
                    <td>{{venta.estadoVenta}}</td>
                    <td class="acciones">
                        <!-- Ver detalle (siempre visible) -->
                        <button class="btn-accion ver" (click)="verModal(venta.idVenta)">
                            <mat-icon color="accent">visibility</mat-icon>
                        </button>

                        <!-- Descargar comprobante (solo completadas) -->
                        <button class="btn-accion"
                            *ngIf="venta.estadoVenta === 'Completado' || venta.estadoVenta === 'Completado'"
                            (click)="generarComprobante(venta.idVenta)">
                            <mat-icon color="primary">download</mat-icon>
                        </button>

                        <!-- Confirmar venta (solo productos pendientes) -->
                        <button class="btn-accion confirmar"
                            *ngIf="venta.tipoVenta === 'productos' && venta.estadoVenta === 'Pendiente'"
                            (click)="confirmarVentaProductos(venta.idVenta)" title="Confirmar y generar comprobante">
                            <mat-icon>check</mat-icon>
                        </button>

                        <!-- Editar (solo productos pendientes) -->
                        <button class="btn-accion editar"
                            *ngIf="venta.tipoVenta === 'productos' && venta.estadoVenta === 'Pendiente'"
                            (click)="editarVenta(venta.idVenta)">
                            <mat-icon class="edit" color="primary">edit</mat-icon>
                        </button>

                        <!-- Nota de cr√©dito (solo canceladas) -->
                        <button *ngIf="venta.estadoVenta === 'Cancelado'" (click)="descargarNotaCredito(venta.idVenta)"
                            class="btn btn-sm btn-primary">
                            Nota Cr√©dito
                        </button>
                    </td>
                </tr>
                <tr *ngIf="ventasFiltrados.length === 0">
                    <td colspan="7" class="text-center text-muted">
                        No hay ventas que coincidan con el filtro.
                    </td>
                </tr>
            </tbody>
        </table>

        <div *ngIf="totalPagina > 1"
            class="paginacion position-absolute bottom-0 start-50 translate-middle-x p-4 text-center mt-5">
            <button class="btn btn-primary me-3" (click)="cambiarPaginaCompra(paginaActualCompra - 1)"
                [disabled]="paginaActualCompra === 1">Anterior</button>
            <span>P√°gina {{ paginaActualCompra }} de {{ totalPagina }}</span>
            <button class="btn btn-primary ms-3" (click)="cambiarPaginaCompra(paginaActualCompra + 1)"
                [disabled]="paginaActualCompra === totalPagina">Siguiente</button>
        </div>
    </div>
    <div *ngIf="mostrarModal" class="modal">
        <div class="modal-content">
            <span class="close" (click)="cerrarModal()">&times;</span>

            <!-- Header mejorado -->
            <div class="modal-header-info">
                <div class="header-title">
                    <mat-icon class="header-icon">receipt_long</mat-icon>
                    <h3 class="h3">Detalle de la Venta</h3>
                </div>
                <div class="tipo-venta-badge" [ngClass]="'badge-' + ventaSeleccionada?.tipoVenta">
                    <mat-icon>{{ventaSeleccionada?.tipoVenta === 'hospedaje' ? 'hotel' : 'inventory_2'}}</mat-icon>
                    {{ventaSeleccionada?.tipoVenta === 'hospedaje' ? 'Hospedaje' : 'Productos'}}
                </div>
            </div>

            <!-- Informaci√≥n principal mejorada -->
            <div class="info-principal">
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">
                            <mat-icon>confirmation_number</mat-icon>
                        </div>
                        <div class="info-content">
                            <span class="info-label">N√∫mero de Comprobante</span>
                            <span class="info-value"
                                *ngIf="ventaSeleccionada?.comprobantePago?.numComprobante; else sinComprobante">
                                {{ ventaSeleccionada.comprobantePago.numComprobante }} -
                                {{ventaSeleccionada.comprobantePago.numComprobante == 'B001' ?
                                ventaSeleccionada.comprobantePago.numSerieBoleta :
                                ventaSeleccionada.comprobantePago.numSerieFactura}}
                            </span>
                            <ng-template #sinComprobante>
                                <span class="info-value sin-comprobante">Sin comprobante</span>
                            </ng-template>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <mat-icon>event</mat-icon>
                        </div>
                        <div class="info-content">
                            <span class="info-label">Fecha</span>
                            <span class="info-value">{{ ventaSeleccionada?.fecha | date: 'dd/MM/yyyy'}}</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <mat-icon>person</mat-icon>
                        </div>
                        <div class="info-content">
                            <span class="info-label">Cliente</span>
                            <span class="info-value">{{ ventaSeleccionada?.cliente?.nombre }}</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">
                            <mat-icon>verified</mat-icon>
                        </div>
                        <div class="info-content">
                            <span class="info-label">Estado</span>
                            <span class="estado-badge" [ngClass]="{
                                'estado-completado': ventaSeleccionada?.estadoVenta === 'Completado',
                                'estado-pendiente': ventaSeleccionada?.estadoVenta === 'Pendiente',
                                'estado-cancelado': ventaSeleccionada?.estadoVenta === 'Cancelado'
                              }">
                                {{ ventaSeleccionada?.estadoVenta }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Resumen de totales -->
                <div class="totales-resumen">
                    <div class="total-item">
                        <span class="total-label">Descuento</span>
                        <span class="total-value">S/. {{ ventaSeleccionada?.descuento }}</span>
                    </div>
                    <div class="total-item">
                        <span class="total-label">IGV</span>
                        <span class="total-value">{{ ventaSeleccionada?.igv }}%</span>
                    </div>
                    <div class="total-item">
                        <span class="total-label">Cargo</span>
                        <span class="total-value">S/. {{ ventaSeleccionada?.cargo }}</span>
                    </div>
                    <div class="total-item total-principal">
                        <span class="total-label">Total</span>
                        <span class="total-value total-final">S/. {{ ventaSeleccionada?.total }}</span>
                    </div>
                </div>
            </div>

            <!-- Secciones con tabs mejorados -->
            <div class="secciones-container">
                <!-- Reservas - Solo para hospedaje -->
                <div class="seccion-detalle" *ngIf="ventaSeleccionada?.tipoVenta === 'hospedaje'">
                    <div class="seccion-header">
                        <mat-icon class="seccion-icon">book_online</mat-icon>
                        <h3 class="h3">Reservas</h3>
                    </div>
                    <div class="tabla-container">
                        <table class="tabla-elegante" *ngIf="ventaSeleccionada.ventaXReserva?.length > 0; else noData">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let reserva of ventaSeleccionada.ventaXReserva">
                                    <td>{{ reserva.reserva?.cliente.nombre }}</td>
                                    <td>{{ reserva.reserva?.tipo }}</td>
                                    <td>{{ reserva.reserva?.fecha_inicio | date: 'dd-MM-yyyy' }}</td>
                                    <td>{{ reserva.reserva?.fecha_fin | date: 'dd-MM-yyyy' }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <ng-template #noData>
                            <div class="no-data">
                                <mat-icon>event_available</mat-icon>
                                <p>No hay reservas registradas</p>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- Habitaciones - Solo para hospedaje -->
                <div class="seccion-detalle" *ngIf="ventaSeleccionada?.tipoVenta === 'hospedaje'">
                    <div class="seccion-header">
                        <mat-icon class="seccion-icon">hotel</mat-icon>
                        <h3 class="h3">Habitaciones</h3>
                    </div>
                    <div class="tabla-container">
                        <table class="tabla-elegante"
                            *ngIf="ventaSeleccionada.ventaHabitacion?.length > 0; else noHabitaciones">
                            <thead>
                                <tr>
                                    <th>N¬∞ Habitaci√≥n</th>
                                    <th>Tipo</th>
                                    <th>Piso</th>
                                    <th>D√≠as</th>
                                    <th>Precio</th>
                                    <th>Sub Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let h of ventaSeleccionada.ventaHabitacion">
                                    <td><strong>{{ h.habitacion?.numero }}</strong></td>
                                    <td>{{ h.habitacion?.tipo_habitacion.nombre }}</td>
                                    <td>Piso {{ h.habitacion?.piso.numero }}</td>
                                    <td>{{ h.dias }}</td>
                                    <td class="precio">S/. {{ h.habitacion?.tipo_habitacion.precio }}</td>
                                    <td class="precio-total">S/. {{ h.subTotal }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <ng-template #noHabitaciones>
                            <div class="no-data">
                                <mat-icon>hotel_class</mat-icon>
                                <p>No hay habitaciones registradas</p>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- Salones - Solo para hospedaje -->
                <div class="seccion-detalle" *ngIf="ventaSeleccionada?.tipoVenta === 'hospedaje'">
                    <div class="seccion-header">
                        <mat-icon class="seccion-icon">meeting_room</mat-icon>
                        <h3 class="h3">Salones de Evento</h3>
                    </div>
                    <div class="tabla-container">
                        <table class="tabla-elegante" *ngIf="ventaSeleccionada.ventaSalon?.length > 0; else noSalones">
                            <thead>
                                <tr>
                                    <th>Sal√≥n</th>
                                    <th>Tipo Tarifa</th>
                                    <th>D√≠as</th>
                                    <th>Precio</th>
                                    <th>Sub Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let s of ventaSeleccionada.ventaSalon">
                                    <td>{{ s.salon?.nombre }}</td>
                                    <td>D√≠a</td>
                                    <td>{{ s.dias }}</td>
                                    <td class="precio">S/. {{ s.salon?.precio_diario }}</td>
                                    <td class="precio-total">S/. {{ s.subTotal }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <ng-template #noSalones>
                            <div class="no-data">
                                <mat-icon>event_seat</mat-icon>
                                <p>No hay salones registrados</p>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- Productos - Para ambos tipos -->
                <div class="seccion-detalle">
                    <div class="seccion-header">
                        <mat-icon class="seccion-icon">inventory_2</mat-icon>
                        <h3 class="h3">Productos</h3>
                    </div>
                    <div class="tabla-container">
                        <table class="tabla-elegante"
                            *ngIf="ventaSeleccionada.detalleVenta?.length > 0; else noProductos">
                            <thead>
                                <tr>
                                    <th>Categor√≠a</th>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Sub Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let producto of ventaSeleccionada.detalleVenta">
                                    <td>{{ producto.producto.categoriaproducto.nombre }}</td>
                                    <td>{{ producto.producto.nombre }}</td>
                                    <td class="cantidad">{{ producto.cantidad }}</td>
                                    <td class="precio">S/. {{ producto.producto.precioVenta }}</td>
                                    <td class="precio-total">S/. {{ producto.subTotal }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <ng-template #noProductos>
                            <div class="no-data">
                                <mat-icon>shopping_basket</mat-icon>
                                <p>No hay productos registrados</p>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- M√©todos de Pago - Para ambos tipos -->
                <div class="seccion-detalle">
                    <div class="seccion-header">
                        <mat-icon class="seccion-icon">payment</mat-icon>
                        <h3 class="h3">M√©todos de Pago</h3>
                    </div>
                    <div class="tabla-container">
                        <table class="tabla-elegante">
                            <thead>
                                <tr>
                                    <th>M√©todo de Pago</th>
                                    <th>Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let m of ventaSeleccionada.ventaMetodoPago">
                                    <td>
                                        <div class="metodo-pago">
                                            <mat-icon [ngClass]="'icono-' + (m.metodoPago?.nombre | lowercase)">
                                                {{m.metodoPago?.nombre === 'Efectivo' ? 'payments' : 'credit_card'}}
                                            </mat-icon>
                                            {{ m.metodoPago?.nombre }}
                                        </div>
                                    </td>
                                    <td class="precio-total">S/. {{ m.pago }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE VENTA HOSPEDAJE -->

    <div *ngIf="modalRegistroHospedaje" class="modalRegistro">
        <div class="modal-content-registro">
            <span class="close" (click)="cerrarMordalRegistro()">&times;</span>
            <h2 class="mb-3">Venta de Hospedaje</h2>

            <form (ngSubmit)="formSubmit()" #formulario="ngForm">

                <!-- Tipo de Comprobante y Correlativo -->
                <div class="comprobante-section mb-3">
                    <mat-form-field class="w-25 me-5">
                        <mat-label>Tipo de Comprobante</mat-label>
                        <select matNativeControl [(ngModel)]="tipo" name="tipo" (change)="boletaOFactura(tipo)"
                            required>
                            <option value="Boleta">Boleta</option>
                            <option value="Factura">Factura</option>
                        </select>
                    </mat-form-field>

                    <mat-form-field class="w-25 me-2">
                        <mat-label>Serie</mat-label>
                        <input type="text" name="numSerie" id="numSerie"
                            [(ngModel)]="venta.comprobantePago.numComprobante" #numSerie="ngModel" required matInput
                            disabled="true">
                    </mat-form-field>

                    <span class="mx-1">-</span>

                    <mat-form-field class="w-25 ms-2" *ngIf="(venta.comprobantePago.numComprobante == 'B001')">
                        <mat-label>Correlativo</mat-label>
                        <input type="text" name="numComprobante" id="numComprobante"
                            [(ngModel)]="venta.comprobantePago.numSerieBoleta" #numComprobante="ngModel" required
                            matInput disabled="true">
                    </mat-form-field>

                    <mat-form-field class="w-25 ms-2" *ngIf="(venta.comprobantePago.numComprobante == 'F001')">
                        <mat-label>Correlativo</mat-label>
                        <input type="text" name="numComprobante" id="numComprobante"
                            [(ngModel)]="venta.comprobantePago.numSerieFactura" #numComprobante="ngModel" required
                            matInput disabled="true">
                    </mat-form-field>
                </div>

                <h3 class="h3 mt-3">Reserva</h3>

                <mat-form-field class="w-100 form-field-small" appearance="outline">
                    <mat-label>Selecciona Reserva</mat-label>
                    <input type="text" id="searchReservas" name="reservaCliente" placeholder="Selecciona la reserva"
                        matInput (input)="filtrarReservas()" [(ngModel)]="reservaSeleccionada"
                        [matAutocomplete]="autoCliente" [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #autoCliente="matAutocomplete"
                        (optionSelected)="seleccionarReserva($event.option.value)" [displayWith]="mostrarReserva">
                        <mat-option *ngFor="let reserva of reservasFiltrado" [value]="reserva">
                            {{reserva.cliente.dniRuc}} | {{reserva.cliente.nombre}} | {{reserva.tipo}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <div *ngIf="venta.ventaXReserva.length === 0" class="alert alert-warning mt-2">
                    <mat-icon>warning</mat-icon> Debe seleccionar una reserva
                </div>

                <!-- Tabla de Reservas Seleccionadas -->
                <div class="tabla-scrollable" *ngIf="venta.ventaXReserva.length > 0">
                    <table mat-table [dataSource]="dataReserva" class="mat-elevation-z8 w-100">

                        <ng-container matColumnDef="cliente">
                            <th mat-header-cell *matHeaderCellDef> Cliente </th>
                            <td mat-cell *matCellDef="let item"> {{ item.reserva?.cliente.nombre }} </td>
                        </ng-container>

                        <ng-container matColumnDef="tipo">
                            <th mat-header-cell *matHeaderCellDef> Tipo </th>
                            <td mat-cell *matCellDef="let item">{{ item.reserva?.tipo }} </td>
                        </ng-container>

                        <ng-container matColumnDef="fechaInicio">
                            <th mat-header-cell *matHeaderCellDef> Fecha Inicio </th>
                            <td mat-cell *matCellDef="let item">{{ item.reserva?.fecha_inicio | date: 'dd-MM-yyyy
                                HH:mm'}} </td>
                        </ng-container>

                        <ng-container matColumnDef="fechaFin">
                            <th mat-header-cell *matHeaderCellDef> Fecha Fin </th>
                            <td mat-cell *matCellDef="let item">{{ item.reserva?.fecha_fin | date: 'dd-MM-yyyy HH:mm'}}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let item; let i = index">
                                <button type="button" mat-icon-button color="warn" (click)="eliminarReserva(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="tablaReserva"></tr>
                        <tr mat-row *matRowDef="let row; columns: tablaReserva;"></tr>
                    </table>
                </div>

                <!-- Informaci√≥n del Cliente (auto-completado desde reserva) -->
                <h3 class="h3 mt-3">Cliente para Facturaci√≥n</h3>

                <!-- Checkbox para mismo cliente -->
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="mismoCliente"
                        [(ngModel)]="mismoClienteFacturacion" [ngModelOptions]="{standalone: true}"
                        (change)="onMismoClienteChange($event)">
                    <label class="form-check-label" for="mismoCliente">
                        Facturar al mismo cliente de la reserva
                    </label>
                </div>

                <!-- Selector de cliente para facturaci√≥n (solo si no es el mismo) -->
                <mat-form-field class="w-100 form-field-small" appearance="outline" *ngIf="!mismoClienteFacturacion">
                    <mat-label>Cliente para Facturaci√≥n</mat-label>
                    <input type="text" id="searchInput" placeholder="Seleccione cliente para facturaci√≥n" matInput
                        (input)="filtrarClientes()" [(ngModel)]="clienteFacturacion" [matAutocomplete]="auto"
                        [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #auto="matAutocomplete"
                        (optionSelected)="seleccionarClienteFacturacion($event.option.value)"
                        [displayWith]="mostrarCliente">
                        <mat-option *ngFor="let cliente of clientesFiltrado" [value]="cliente">
                            {{cliente.dniRuc}} | {{cliente.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <!-- Mostrar informaci√≥n del cliente seleccionado -->
                <div *ngIf="venta.cliente?.nombre" class="cliente-info alert alert-info mt-2">
                    <strong>Facturar a:</strong> {{venta.cliente.nombre}} - {{venta.cliente.dniRuc}}
                </div>

                <h3 class="h3 mt-3">Habitaciones</h3>

                <table mat-table [dataSource]="dataHabitacion" class="mat-elevation-z8"
                    *ngIf="dataHabitacion.data.length > 0">

                    <ng-container matColumnDef="numero">
                        <th mat-header-cell *matHeaderCellDef>N¬∞ Habitaci√≥n</th>
                        <td mat-cell *matCellDef="let element">{{ element.habitacion.numero }}</td>
                    </ng-container>

                    <ng-container matColumnDef="tipo">
                        <th mat-header-cell *matHeaderCellDef>Tipo</th>
                        <td mat-cell *matCellDef="let element">{{ element.habitacion.tipo_habitacion?.nombre }}</td>
                    </ng-container>

                    <ng-container matColumnDef="piso">
                        <th mat-header-cell *matHeaderCellDef>Piso</th>
                        <td mat-cell *matCellDef="let element">Piso {{ element.habitacion.piso.numero }}</td>
                    </ng-container>

                    <ng-container matColumnDef="dias">
                        <th mat-header-cell *matHeaderCellDef>D√≠as</th>
                        <td mat-cell *matCellDef="let element">{{ element.dias }}</td>
                    </ng-container>

                    <ng-container matColumnDef="precio">
                        <th mat-header-cell *matHeaderCellDef>Precio por Noche</th>
                        <td mat-cell *matCellDef="let element">S/. {{ element.habitacion.tipo_habitacion?.precio |
                            number:'1.2-2' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="subtotal">
                        <th mat-header-cell *matHeaderCellDef>Sub Total</th>
                        <td mat-cell *matCellDef="let element">S/. {{ element.habitacion.tipo_habitacion?.precio *
                            element.dias | number:'1.2-2' }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="tablaHabitacion"></tr>
                    <tr mat-row *matRowDef="let row; columns: tablaHabitacion;"></tr>
                </table>

                <h3 class="h3 mt-3">Salones de Evento</h3>

                <table mat-table [dataSource]="dataSalon" class="mat-elevation-z8" *ngIf="dataSalon.data.length > 0">

                    <ng-container matColumnDef="nombre">
                        <th mat-header-cell *matHeaderCellDef>Sal√≥n</th>
                        <td mat-cell *matCellDef="let element">{{ element.salon.nombre }}</td>
                    </ng-container>

                    <ng-container matColumnDef="tarifa">
                        <th mat-header-cell *matHeaderCellDef>Tipo Tarifa</th>
                        <td mat-cell *matCellDef="let element">Diario</td>
                    </ng-container>

                    <ng-container matColumnDef="dias/horas">
                        <th mat-header-cell *matHeaderCellDef>D√≠as</th>
                        <td mat-cell *matCellDef="let element">{{ element.dias }}</td>
                    </ng-container>

                    <ng-container matColumnDef="precio">
                        <th mat-header-cell *matHeaderCellDef>Precio por D√≠a</th>
                        <td mat-cell *matCellDef="let element">S/. {{ element.salon.precio_diario | number:'1.2-2' }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="subtotal">
                        <th mat-header-cell *matHeaderCellDef>Sub Total</th>
                        <td mat-cell *matCellDef="let element">S/. {{ element.salon.precio_diario * element.dias |
                            number:'1.2-2' }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="tablaSalon"></tr>
                    <tr mat-row *matRowDef="let row; columns: tablaSalon;"></tr>
                </table>

                <!-- Validaci√≥n: debe seleccionar una reserva -->


                <h3 class="h3 mt-3">M√©todo de Pago</h3>

                <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Selecciona M√©todo de Pago</mat-label>
                    <input type="text" id="searchMetodo" placeholder="Seleccione m√©todo de pago" matInput
                        (input)="filtrarMetodos()" [(ngModel)]="metodoSeleccionada" [matAutocomplete]="autoMetodo"
                        [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #autoMetodo="matAutocomplete"
                        (optionSelected)="agregarMetodo($event.option.value)" [displayWith]="mostrarMetodo">
                        <mat-option *ngFor="let metodo of metodosFiltrado" [value]="metodo">
                            {{metodo.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <div class="tabla-scrollable">
                    <table mat-table [dataSource]="dataMetodo" class="mat-elevation-z8 w-100"
                        *ngIf="venta.ventaMetodoPago.length > 0">

                        <ng-container matColumnDef="nombre">
                            <th mat-header-cell *matHeaderCellDef> M√©todo de Pago </th>
                            <td mat-cell *matCellDef="let item"> {{ item.metodoPago.nombre }} </td>
                        </ng-container>

                        <ng-container class="pago" matColumnDef="pago">
                            <th mat-header-cell *matHeaderCellDef> Pago </th>
                            <td mat-cell *matCellDef="let item">
                                S/. <input type="number" [(ngModel)]="item.pago" [ngModelOptions]="{standalone: true}"
                                    min="0.01" class="w-50" step="0.01">
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let item; let i = index">
                                <button type="button" mat-icon-button color="warn" (click)="eliminarMetodo(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="tablaMetodo"></tr>
                        <tr mat-row *matRowDef="let row; columns: tablaMetodo;"></tr>
                    </table>
                </div>

                <!-- Validaci√≥n: debe tener m√©todo de pago -->
                <div *ngIf="venta.ventaMetodoPago.length === 0" class="alert alert-warning mt-2">
                    <mat-icon>warning</mat-icon> Debe agregar al menos un m√©todo de pago
                </div>

                <!-- Totales -->
                <div class="text-left mt-3" *ngIf="venta.ventaHabitacion.length > 0 || venta.ventaSalon.length > 0">
                    <span class="ultimos">
                        <mat-form-field class="descuento w-10">
                            <mat-label>Descuento</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.descuento"
                                (ngModelChange)="actualizarTotales()" placeholder="0" value="0">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field class="cargo w-10">
                            <mat-label>Cargo</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.cargo"
                                (ngModelChange)="actualizarTotales()" placeholder="0" value="0">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field class="igv w-10">
                            <mat-label>IGV</mat-label>
                            <select matNativeControl [(ngModel)]="tipoIgv" name="tipoIgv"
                                (ngModelChange)="seleccionarIgv(tipoIgv); actualizarTotales()" required>
                                <option value="0">0%</option>
                                <option value="10">10%</option>
                                <option value="18">18%</option>
                            </select>
                        </mat-form-field>

                        <mat-form-field class="w-10">
                            <mat-label>Total</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.total" required
                                readonly min="0.01">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>
                    </span>
                </div>

                <!-- Info sobre el proceso -->
                <div class="alert alert-info mt-3">
                    <mat-icon>info</mat-icon>
                    El pago de hospedaje se registrar√° inmediatamente y se generar√° el comprobante.
                </div>

                <div class="form-actions mt-3">
                    <button type="submit" mat-raised-button
                        [disabled]="venta.ventaXReserva.length === 0 || venta.ventaMetodoPago.length === 0"
                        color="primary" class="btn-primary">
                        Registrar Pago de Hospedaje
                    </button>
                    <button type="button" mat-raised-button color="warn" class="btn-secondary ms-2"
                        (click)="cerrarMordalRegistro()">
                        Cancelar
                    </button>
                </div>

            </form>

        </div>
    </div>





    <!-- MODAL DE VENTA PRODUCTOS -->

    <div *ngIf="modalRegistroProductos" class="modalRegistro">
        <div class="modal-content-registro">
            <span class="close" (click)="cerrarMordalRegistro()">&times;</span>
            <h2 class="mb-3">Venta de Productos</h2>

            <form (ngSubmit)="formSubmit()" #formulario="ngForm">

                <!-- Solo mostrar tipo de comprobante para informaci√≥n, no editable -->
                <div class="info-proceso mb-3">
                    <div class="alert alert-info">
                        <mat-icon>info</mat-icon>
                        La venta quedar√° pendiente. El comprobante se generar√° al confirmar la venta.
                    </div>
                </div>

                <h3 class="h3 mt-3">Cliente</h3>

                <mat-form-field class="w-100 form-field-small" appearance="outline">
                    <mat-label>Selecciona Cliente</mat-label>
                    <input type="text" id="searchInput" [name]="venta.cliente.dniRuc" placeholder="Seleccione cliente"
                        matInput (input)="filtrarClientes()" [(ngModel)]="venta.cliente" [required]="true"
                        [matAutocomplete]="auto" [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="seleccionarCliente($event.option.value)"
                        [displayWith]="mostrarCliente">
                        <mat-option *ngFor="let cliente of clientesFiltrado" [value]="cliente">
                            {{cliente.dniRuc}} | {{cliente.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <h3 class="h3 mt-3">Productos</h3>

                <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Selecciona Producto</mat-label>
                    <input type="text" id="searchInput" placeholder="Seleccione producto" matInput
                        (input)="filtrarProductos()" [(ngModel)]="productoBusqueda" [matAutocomplete]="autoProducto"
                        [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #autoProducto="matAutocomplete"
                        (optionSelected)="agregarProducto($event.option.value)" [displayWith]="mostrarNombreProducto">
                        <mat-option *ngFor="let producto of productosFiltrados" [value]="producto">
                            {{producto.nombre}} - Stock: {{producto.stock}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <div class="tabla-scrollable">
                    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 w-100"
                        *ngIf="venta.detalleVenta.length > 0">

                        <ng-container matColumnDef="nombre">
                            <th mat-header-cell *matHeaderCellDef> Producto </th>
                            <td mat-cell *matCellDef="let item"> {{ item.producto?.nombre }} </td>
                        </ng-container>

                        <ng-container matColumnDef="unidad">
                            <th mat-header-cell *matHeaderCellDef> Stock Disponible </th>
                            <td mat-cell *matCellDef="let item"> {{ item.producto?.stock }} </td>
                        </ng-container>

                        <ng-container class="cantidad" matColumnDef="cantidad">
                            <th mat-header-cell *matHeaderCellDef> Cantidad </th>
                            <td mat-cell *matCellDef="let item">
                                <input type="number" [(ngModel)]="item.cantidad" [ngModelOptions]="{standalone: true}"
                                    (ngModelChange)="actualizarSubtotal(item)" min="1" [max]="item.producto?.stock"
                                    class="w-50">
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="precio">
                            <th mat-header-cell *matHeaderCellDef> Precio </th>
                            <td mat-cell *matCellDef="let item">
                                S/. {{item.producto?.precioVenta | number:'1.2-2'}}
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="subtotal">
                            <th mat-header-cell *matHeaderCellDef> Subtotal </th>
                            <td mat-cell *matCellDef="let item"> S/ {{ item.subTotal | number:'1.2-2' }} </td>
                        </ng-container>

                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let item; let i = index">
                                <button type="button" mat-icon-button color="warn" (click)="eliminarProducto(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="columnasTabla"></tr>
                        <tr mat-row *matRowDef="let row; columns: columnasTabla;"></tr>
                    </table>
                </div>

                <!-- Validaci√≥n: debe tener al menos un producto -->
                <div *ngIf="venta.detalleVenta.length === 0" class="alert alert-warning mt-2">
                    <mat-icon>warning</mat-icon> Debe agregar al menos un producto
                </div>

                <h3 class="h3 mt-3">M√©todo de Pago</h3>

                <mat-form-field class="w-100" appearance="outline">
                    <mat-label>Selecciona M√©todo de Pago</mat-label>
                    <input type="text" id="searchMetodo" placeholder="Seleccione m√©todo de pago" matInput
                        (input)="filtrarMetodos()" [(ngModel)]="metodoSeleccionada" [matAutocomplete]="autoMetodo"
                        [ngModelOptions]="{standalone: true}">
                    <mat-autocomplete #autoMetodo="matAutocomplete"
                        (optionSelected)="agregarMetodo($event.option.value)" [displayWith]="mostrarMetodo">
                        <mat-option *ngFor="let metodo of metodosFiltrado" [value]="metodo">
                            {{metodo.nombre}}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <div class="tabla-scrollable">
                    <table mat-table [dataSource]="dataMetodo" class="mat-elevation-z8 w-100"
                        *ngIf="venta.ventaMetodoPago.length > 0">

                        <ng-container matColumnDef="nombre">
                            <th mat-header-cell *matHeaderCellDef> M√©todo de Pago </th>
                            <td mat-cell *matCellDef="let item"> {{ item.metodoPago.nombre }} </td>
                        </ng-container>

                        <ng-container class="pago" matColumnDef="pago">
                            <th mat-header-cell *matHeaderCellDef> Pago </th>
                            <td mat-cell *matCellDef="let item">
                                S/. <input type="number" [(ngModel)]="item.pago" [ngModelOptions]="{standalone: true}"
                                    min="0.01" class="w-50" step="0.01">
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="acciones">
                            <th mat-header-cell *matHeaderCellDef> Acciones </th>
                            <td mat-cell *matCellDef="let item; let i = index">
                                <button type="button" mat-icon-button color="warn" (click)="eliminarMetodo(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="tablaMetodo"></tr>
                        <tr mat-row *matRowDef="let row; columns: tablaMetodo;"></tr>
                    </table>
                </div>

                <!-- Validaci√≥n: debe tener al menos un m√©todo de pago -->
                <div *ngIf="venta.ventaMetodoPago.length === 0" class="alert alert-warning mt-2">
                    <mat-icon>warning</mat-icon> Debe agregar al menos un m√©todo de pago
                </div>

                <!-- Totales simplificados -->
                <div class="text-left mt-3" *ngIf="venta.detalleVenta.length > 0">
                    <span class="ultimos">
                        <mat-form-field class="descuento w-10">
                            <mat-label>Descuento</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.descuento"
                                (ngModelChange)="actualizarTotales()" placeholder="0" value="0">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field class="cargo w-10">
                            <mat-label>Cargo</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.cargo"
                                (ngModelChange)="actualizarTotales()" placeholder="0" value="0">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>

                        <mat-form-field class="igv w-10">
                            <mat-label>IGV</mat-label>
                            <select matNativeControl [(ngModel)]="tipoIgv" name="tipoIgv"
                                (ngModelChange)="seleccionarIgv(tipoIgv); actualizarTotales()" required>
                                <option value="0">0%</option>
                                <option value="10">10%</option>
                                <option value="18">18%</option>
                            </select>
                        </mat-form-field>

                        <mat-form-field class="w-10">
                            <mat-label>Total</mat-label>
                            <input [ngModelOptions]="{standalone: true}" matInput [(ngModel)]="venta.total" required
                                readonly min="0.01">
                            <span matTextPrefix>S/.&nbsp;</span>
                        </mat-form-field>
                    </span>
                </div>

                <!-- Info sobre el comprobante -->
                <div class="alert alert-info mt-3" *ngIf="!venta.idVenta">
                    <mat-icon>info</mat-icon>
                    La venta quedar√° pendiente. El tipo de comprobante (Boleta/Factura) se seleccionar√° al confirmar la
                    venta.
                </div>

                <div class="form-actions mt-3">
                    <button type="submit" mat-raised-button
                        [disabled]="venta.detalleVenta.length === 0 || venta.ventaMetodoPago.length === 0"
                        color="primary" class="btn-primary">
                        {{venta.idVenta ? 'Actualizar' : 'Guardar'}} Venta
                    </button>
                    <button type="button" mat-raised-button color="warn" class="btn-secondary ms-2"
                        (click)="cerrarMordalRegistro()">
                        Cancelar
                    </button>
                </div>

            </form>

        </div>
    </div>

</div>