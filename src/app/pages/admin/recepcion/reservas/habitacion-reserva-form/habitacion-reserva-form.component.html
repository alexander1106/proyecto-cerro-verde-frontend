<div class="form-container">
  <h2>{{ isEditing ? 'Editar' : 'Nueva' }} Reserva de Habitación</h2>

  <div *ngIf="error" class="error-message">{{ error }}</div>
  <div *ngIf="loading" class="loading">Cargando datos...</div>

  <form [formGroup]="reservaForm" (ngSubmit)="onSubmit()" *ngIf="!loading">
    
    <!-- Paso 1: Información general -->
    <div class="form-section" *ngIf="paso === 1">
      <h3>Información de la Reserva</h3>

      <!-- Cliente -->
      <div class="form-group">
        <label for="cliente">Cliente:</label>
        <div class="cliente-select-wrapper">
          <ng-select
            [items]="clientes"
            bindLabel="dniRuc"
            bindValue="idCliente"
            placeholder="Buscar cliente..."
            formControlName="cliente"
            [searchFn]="customSearch"
            [searchable]="true"
            [class.invalid]="reservaForm.get('cliente')?.invalid && reservaForm.get('cliente')?.touched">
            <ng-template ng-option-tmp let-item="item">
              {{ item.nombre }} ({{ item.dniRuc }})
            </ng-template>
      
            <ng-template ng-label-tmp let-item="item">
              {{ item.nombre }} <span *ngIf="item.dniRuc">({{ item.dniRuc }})</span>
            </ng-template>
          </ng-select>
      
          <button type="button" class="btn-nuevo-cliente" (click)="abrirModalCliente()">+</button>
        </div>
      
        <div class="error-hint" *ngIf="reservaForm.get('cliente')?.invalid && reservaForm.get('cliente')?.touched">
          Cliente es requerido
        </div>
      </div>
      

      <!-- Agrupamos fecha de inicio y fin en una fila -->
      <div class="row">
        <div class="form-group col-md-6">
          <label for="fecha_inicio">Fecha de Inicio:</label>
          <input 
            type="datetime-local" 
            id="fecha_inicio" 
            formControlName="fecha_inicio"
            [class.invalid]="reservaForm.get('fecha_inicio')?.invalid && reservaForm.get('fecha_inicio')?.touched">
          <div class="error-hint" *ngIf="reservaForm.get('fecha_inicio')?.touched && reservaForm.get('fecha_inicio')?.errors?.['required']">
            Fecha de inicio es requerida
          </div>
          <div class="error-hint" *ngIf="reservaForm.get('fecha_inicio')?.errors?.['fechaPasada'] && reservaForm.get('fecha_inicio')?.touched">
            La fecha de inicio no puede ser anterior a hoy.
          </div>
        </div>

        <div class="form-group col-md-6">
          <label for="fecha_fin">Fecha de Fin:</label>
          <input 
            type="datetime-local" 
            id="fecha_fin" 
            formControlName="fecha_fin"
            [class.invalid]="reservaForm.get('fecha_fin')?.invalid && reservaForm.get('fecha_fin')?.touched">
          <div class="error-hint" *ngIf="reservaForm.get('fecha_fin')?.hasError('required') && reservaForm.get('fecha_fin')?.touched">
            Fecha de fin es requerida
          </div>
          <div class="error-hint" *ngIf="reservaForm.hasError('fechaInvalida') && (reservaForm.get('fecha_fin')?.touched || reservaForm.get('fecha_inicio')?.touched)">
            La fecha de fin debe ser posterior a la fecha de inicio.
          </div>
        </div>
      </div>


      <!-- Número de personas -->
      <div class="form-group">
        <label for="nro_persona">Número de Personas:</label>
        <input
          type="number"
          id="nro_persona"
          placeholder="Número de personas de la reserva"
          formControlName="nro_persona"
          min="1"
          [class.invalid]="reservaForm.get('nro_persona')?.invalid && reservaForm.get('nro_persona')?.touched">
        <div class="error-hint" *ngIf="reservaForm.get('nro_persona')?.hasError('required') && reservaForm.get('nro_persona')?.touched">
          Este campo es obligatorio
        </div>
        <div class="error-hint" *ngIf="reservaForm.get('nro_persona')?.hasError('min') && reservaForm.get('nro_persona')?.touched">
          Debe haber al menos una persona
        </div>
      </div>

      <!-- Comentarios -->
      <div class="form-group">
        <label for="comentarios">Comentarios:</label>
        <textarea id="comentarios" formControlName="comentarios" rows="3"></textarea>
      </div>

      <!-- Botón para continuar -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onCancel()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="irPasoDos()">Continuar</button>
      </div>
    </div>

    <!-- Paso 2: Selección de habitaciones -->
    <div class="form-section" *ngIf="paso === 2">
      <h3>Selección de Habitaciones</h3>

      <div class="form-group">
        <label for="search">Buscar habitación:</label>
        <input 
          id="search"
          type="text"
          [(ngModel)]="filtroHabitaciones"
          placeholder="Buscar habitación por número, tipo, piso o precio"
          [ngModelOptions]="{ standalone: true }">
      </div>

      <table class="habitaciones-table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Tipo</th>
            <th>Piso</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Seleccionar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let habitacion of habitacionesFiltradas()">
            <td>{{ habitacion.numero }}</td>
            <td>{{ habitacion.tipo_habitacion.nombre }}</td>
            <td>{{ habitacion.piso.numero }}</td>
            <td>S/.{{ habitacion.tipo_habitacion.precio }}</td>
            <td>{{ habitacion.estado_habitacion }}</td>
            <td>
              <input
                type="checkbox"
                [checked]="isHabitacionSelected(habitacion)"
                (change)="toggleHabitacion(habitacion)" />
            </td>
          </tr>
        </tbody>
      </table>

      <div class="error-hint" *ngIf="habitacionesArray.invalid && reservaForm.touched && habitacionesArray.length === 0">
        Debe seleccionar al menos una habitación
      </div>

      <div class="selected-summary" *ngIf="habitacionesArray.length > 0">
        <h5>Habitaciones Seleccionadas:</h5>
        <ul>
          <li *ngFor="let h of habitacionesArray.value">
            Habitación {{ h.numero }} - Piso: {{ h.piso.numero }} - Tipo: {{ h.tipo_habitacion.nombre }}
            <span *ngIf="habitacionesConError.includes(h.id_habitacion)" class="error-hint">
              → Esta habitación solo permite hasta {{ h.tipo_habitacion.cantidadtipo }} personas.
            </span>
            <button type="button" (click)="toggleHabitacion(h)">Quitar</button>
          </li>
        </ul>
        
      </div>

      <div class="error-hint" *ngIf="reservaForm.errors?.['capacidadInsuficiente'] && reservaForm.touched">
        El número de personas de la reserva no puede exceder la cantidad designada al tipo de habitación.
      </div>
      

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="paso = 1">Volver</button>
        <button type="submit" class="btn btn-primary" [disabled]="submitting">
          {{ submitting ? 'Guardando...' : (isEditing ? 'Actualizar' : 'Guardar') }}
        </button>
      </div>
    </div>
  </form>
</div>

<!-- modal -->
<div class="modal-cliente-backdrop" *ngIf="mostrarModalCliente">
  <div class="modal-cliente">
    <h3>Nuevo Cliente</h3>
    <form [formGroup]="nuevoClienteForm" (ngSubmit)="guardarCliente()">
      <div class="form-group">
        <label>DNI o RUC:</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" formControlName="dniRuc" maxlength="11">
          <button type="button" (click)="buscarDni()" class="btn btn-secondary">Buscar</button>
        </div>
        <div *ngIf="nuevoClienteForm.get('dniRuc')?.invalid && nuevoClienteForm.get('dniRuc')?.touched" class="error">
          DNI o RUC requerido (8 u 11 dígitos)
        </div>
      </div>

      <div class="form-group">
        <label>Nombre:</label>
        <input type="text" formControlName="nombre">
        <div *ngIf="nuevoClienteForm.get('nombre')?.invalid && nuevoClienteForm.get('nombre')?.touched" class="error">
          Nombre requerido
        </div>
      </div>

      <div class="form-group">
        <label>Correo:</label>
        <input type="email" formControlName="correo">
        <div *ngIf="nuevoClienteForm.get('correo')?.invalid && nuevoClienteForm.get('correo')?.touched" class="error">
          Correo inválido
        </div>
      </div>

      <div class="form-group">
        <label>Teléfono:</label>
        <input type="text" formControlName="telefono" maxlength="15">
        <div *ngIf="nuevoClienteForm.get('telefono')?.invalid && nuevoClienteForm.get('telefono')?.touched" class="error">
          Teléfono requerido
        </div>
      </div>

      <div class="form-group">
        <label>País:</label>
        <input type="text" formControlName="pais">
        <div *ngIf="nuevoClienteForm.get('pais')?.invalid && nuevoClienteForm.get('pais')?.touched" class="error">
          País requerido
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="nuevoClienteForm.invalid" class="btn-primary">Guardar</button>
        <button type="button" class="btn-secondary" (click)="cerrarModalCliente()">Cancelar</button>
      </div>
    </form>
  </div>
</div>





